<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>TranzyNote Analytics Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; padding: 2rem; }
        h1 { color: #818cf8; margin-bottom: 1.5rem; }
        h2 { color: #a5b4fc; margin: 1.5rem 0 0.75rem; font-size: 1.1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .card { background: #1e293b; border-radius: 12px; padding: 1.5rem; border: 1px solid #334155; }
        .card .number { font-size: 2.5rem; font-weight: 700; color: #818cf8; }
        .card .label { font-size: 0.85rem; color: #94a3b8; margin-top: 0.25rem; }
        table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 12px; overflow: hidden; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #334155; }
        th { background: #334155; color: #a5b4fc; font-size: 0.85rem; text-transform: uppercase; }
        td { font-size: 0.9rem; }
        .refresh { background: #6366f1; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .refresh:hover { background: #4f46e5; }
        .note { color: #64748b; font-size: 0.8rem; margin-top: 1rem; }
        #noData { color: #f87171; display: none; padding: 2rem; text-align: center; }
    </style>
</head>
<body>
    <h1>ðŸ“Š TranzyNote Analytics</h1>
    <button class="refresh" onclick="loadStats()">Refresh</button>
    <button class="refresh" style="background:#ef4444;margin-left:0.5rem;" onclick="resetStats()">Reset All</button>
    <p class="note">This dashboard reads from your browser's localStorage. Data is per-device. Visit the main site first to start collecting data.</p>

    <div id="noData">No analytics data found. Visit <a href="/" style="color:#818cf8">the homepage</a> first.</div>

    <h2>Overview</h2>
    <div class="grid">
        <div class="card"><div class="number" id="totalVisits">0</div><div class="label">Total Visits</div></div>
        <div class="card"><div class="number" id="totalDownloads">0</div><div class="label">Download Clicks</div></div>
        <div class="card"><div class="number" id="totalEvents">0</div><div class="label">Total Events</div></div>
        <div class="card"><div class="number" id="lastVisit">-</div><div class="label">Last Visit</div></div>
    </div>

    <h2>Attribution (UTM Sources)</h2>
    <div class="grid">
        <div class="card">
            <div class="label">First Touch</div>
            <div id="firstTouch" style="margin-top:0.5rem; font-size:0.9rem;">-</div>
        </div>
        <div class="card">
            <div class="label">Last Touch</div>
            <div id="lastTouch" style="margin-top:0.5rem; font-size:0.9rem;">-</div>
        </div>
    </div>

    <h2>Source Breakdown</h2>
    <table>
        <thead><tr><th>Source</th><th>Events</th></tr></thead>
        <tbody id="sourceTable"></tbody>
    </table>

    <h2>Recent Events (Last 20)</h2>
    <table>
        <thead><tr><th>Time</th><th>Category</th><th>Action</th><th>Label</th><th>Page</th></tr></thead>
        <tbody id="eventsTable"></tbody>
    </table>

    <h2>Download Events</h2>
    <table>
        <thead><tr><th>Time</th><th>Type</th><th>UTM Source</th><th>Referrer</th></tr></thead>
        <tbody id="downloadsTable"></tbody>
    </table>

    <script>
    function loadStats() {
        var events = JSON.parse(localStorage.getItem('tn_events') || '[]');
        var visitor = {
            visits: parseInt(localStorage.getItem('tn_visit_count') || '0', 10),
            downloads: parseInt(localStorage.getItem('tn_download_count') || '0', 10)
        };
        var firstUTM = JSON.parse(localStorage.getItem('tn_utm_first') || '{}');
        var lastUTM = JSON.parse(localStorage.getItem('tn_utm_last') || '{}');

        if (events.length === 0) {
            document.getElementById('noData').style.display = 'block';
            return;
        }
        document.getElementById('noData').style.display = 'none';

        document.getElementById('totalVisits').textContent = visitor.visits;
        document.getElementById('totalDownloads').textContent = visitor.downloads;
        document.getElementById('totalEvents').textContent = events.length;
        
        var lastEvt = events[events.length - 1];
        document.getElementById('lastVisit').textContent = lastEvt ? new Date(lastEvt.ts).toLocaleString() : '-';
        document.getElementById('lastVisit').style.fontSize = '0.9rem';

        document.getElementById('firstTouch').textContent = Object.keys(firstUTM).length ? JSON.stringify(firstUTM, null, 2) : '(direct)';
        document.getElementById('lastTouch').textContent = Object.keys(lastUTM).length ? JSON.stringify(lastUTM, null, 2) : '(direct)';

        // Source breakdown
        var sources = {};
        events.forEach(function(e) {
            var src = (e.attribution && e.attribution.last_touch && e.attribution.last_touch.utm_source) || 'organic/direct';
            sources[src] = (sources[src] || 0) + 1;
        });
        var sourceHTML = '';
        Object.keys(sources).sort(function(a,b) { return sources[b] - sources[a]; }).forEach(function(s) {
            sourceHTML += '<tr><td>' + s + '</td><td>' + sources[s] + '</td></tr>';
        });
        document.getElementById('sourceTable').innerHTML = sourceHTML || '<tr><td colspan="2">No data</td></tr>';

        // Recent events
        var recent = events.slice(-20).reverse();
        var evtHTML = '';
        recent.forEach(function(e) {
            evtHTML += '<tr><td>' + new Date(e.ts).toLocaleTimeString() + '</td><td>' + e.category + '</td><td>' + e.action + '</td><td>' + (e.label || '') + '</td><td>' + e.page + '</td></tr>';
        });
        document.getElementById('eventsTable').innerHTML = evtHTML || '<tr><td colspan="5">No events</td></tr>';

        // Downloads
        var downloads = events.filter(function(e) { return e.category === 'download'; });
        var dlHTML = '';
        downloads.forEach(function(e) {
            var src = (e.attribution && e.attribution.last_touch && e.attribution.last_touch.utm_source) || 'organic';
            dlHTML += '<tr><td>' + new Date(e.ts).toLocaleString() + '</td><td>' + e.label + '</td><td>' + src + '</td><td>' + (e.referrer || '-') + '</td></tr>';
        });
        document.getElementById('downloadsTable').innerHTML = dlHTML || '<tr><td colspan="4">No downloads yet</td></tr>';
    }

    function resetStats() {
        if (!confirm('Reset all analytics data? This cannot be undone.')) return;
        localStorage.removeItem('tn_events');
        localStorage.removeItem('tn_visit_count');
        localStorage.removeItem('tn_download_count');
        localStorage.removeItem('tn_utm_first');
        localStorage.removeItem('tn_utm_last');
        loadStats();
        alert('Analytics data cleared!');
    }

    loadStats();
    </script>
</body>
</html>
